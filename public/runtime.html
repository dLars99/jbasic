<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>jBASIC Runtime</title>
    <style>
      body {
        font-family: system-ui, Arial;
        background: #111;
        color: #eee;
        padding: 10px;
      }
      #output {
        white-space: pre-wrap;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h3>jBASIC Runtime</h3>
    <div id="output"></div>
    <script type="module">
      import { createRunner } from "/src/interpreter/basic.ts";

      const outputElement = document.getElementById("output");
      function append(msg) {
        const lineEl = document.createElement("div");
        lineEl.textContent = String(msg);
        outputElement.appendChild(lineEl);
      }

      let pendingInputElement = null;
      function requestInput(promptText) {
        return new Promise((resolve) => {
          const lineEl = document.createElement("div");
          lineEl.style.fontFamily = "monospace";
          lineEl.style.display = "flex";
          lineEl.style.alignItems = "center";
          const promptSpanEl = document.createElement("span");
          if (promptText) promptSpanEl.textContent = promptText + " ";
          const inputElement = document.createElement("input");
          inputElement.type = "text";
          inputElement.className = "jbasic-runtime-input";
          inputElement.style.background = "transparent";
          inputElement.style.color = "inherit";
          inputElement.style.border = "none";
          inputElement.style.outline = "none";
          inputElement.style.font = "inherit";
          inputElement.style.width = "40%";
          inputElement.style.caretColor = "white";

          lineEl.appendChild(promptSpanEl);
          lineEl.appendChild(inputElement);
          outputElement.appendChild(lineEl);
          inputElement.focus();
          pendingInputElement = inputElement;

          function finish(val) {
            try {
              inputElement.remove();
            } catch (err) {}
            const valueSpan = document.createElement("span");
            valueSpan.textContent = String(val == null ? "" : val);
            promptSpanEl.appendChild(valueSpan);
            pendingInputElement = null;
            resolve(val == null ? "" : val);
          }

          inputElement.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
              finish(inputElement.value);
            } else if (event.key === "Escape") {
              finish("");
            }
          });

          // notify opener (for compatibility), but primary input happens here
          if (window.opener)
            window.opener.postMessage(
              { type: "inputRequest", prompt: promptText },
              "*",
            );

          // safety timeout: resolve empty after 2 minutes
          setTimeout(() => {
            if (pendingInputElement === inputElement) finish("");
          }, 120000);
        });
      }

      window.addEventListener("message", (event) => {
        const message = event.data;
        if (!message || !message.type) return;
        if (message.type === "run") {
          outputElement.innerHTML = "";
          const runner = createRunner(
            message.code,
            (o) => {
              append(o);
              window.opener &&
                window.opener.postMessage({ type: "output", payload: o }, "*");
            },
            async (promptName) => {
              // ask opener for input and wait
              const v = await requestInput(promptName);
              return v;
            },
            message.instructionLimit ?? null,
          );
          window._jbasic_runner = runner;
          runner.start();
        } else if (message.type === "stop") {
          if (window._jbasic_runner) window._jbasic_runner.stop();
          append("[Stopped]");
        } else if (message.type === "input") {
          console.log("runtime <- opener: input", message.value);
          if (pendingInputElement) {
            pendingInputElement.value =
              message.value == null ? "" : message.value;
            const keyboardEvent = new KeyboardEvent("keydown", {
              key: "Enter",
            });
            pendingInputElement.dispatchEvent(keyboardEvent);
          } else {
            append(String(message.value));
          }
        }
      });

      // notify opener we're ready
      window.opener && window.opener.postMessage({ type: "ready" }, "*");
    </script>
  </body>
</html>
